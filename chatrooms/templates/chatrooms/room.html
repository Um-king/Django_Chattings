<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Chat Room</title>
</head>
<body>
    <textarea id="chat-log" cols="100" rows="20"></textarea><br>
    <input id="chat-message-input" type="text" size="100"><br>
    <input id="chat-message-submit" type="button" value="Send"><br>
    <button id="start-button">Start</button>

    <div id="video-container">
        <video id="local-video" autoplay muted></video>
    </div>
    {{ room_name|json_script:"room-name" }}
    <script>
        const roomName = JSON.parse(document.getElementById('room-name').textContent); // 이 줄은 서버 템플릿과 관련되어 있어 실제 데이터 바인딩이 필요합니다.
        const wsStart = window.location.protocol === "https:" ? "wss://" : "ws://";
        const chatSocket = new WebSocket(
            wsStart + window.location.host + '/ws/chat/' + roomName + '/'
        );

        const configuration = {'iceServers': [{'urls': 'stun:stun.l.google.com:19302'}]};
        let localStream = null;
        let peerConnections = {};

        document.getElementById('start-button').onclick = () => {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                    .then(stream => {
                        document.getElementById('local-video').srcObject = stream;
                        localStream = stream;
                    }).catch(error => console.error('getUserMedia error:', error));
            } else {
                console.error('Your browser does not support getUserMedia API');
            }
        };

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            if (data.signal && data.from) {
                if (!peerConnections[data.from]) {
                    createPeerConnection(data.from);
                }
                const signal = data.signal;
                if (signal.sdp) {
                    const sdp = new RTCSessionDescription(signal.sdp);
                    peerConnections[data.from].setRemoteDescription(sdp).then(() => {
                        if (signal.sdp.type === 'offer') {
                            peerConnections[data.from].createAnswer().then(answer => {
                                peerConnections[data.from].setLocalDescription(answer).then(() => {
                                    chatSocket.send(JSON.stringify({
                                        'signal': {'sdp': peerConnections[data.from].localDescription},
                                        'to': data.from
                                    }));
                                });
                            });
                        }
                    });
                } else if (signal.candidate) {
                    const candidate = new RTCIceCandidate(signal.candidate);
                    peerConnections[data.from].addIceCandidate(candidate);
                }
            }
        };

        function createPeerConnection(socketID) {
            const pc = new RTCPeerConnection(configuration);
            peerConnections[socketID] = pc;

            pc.onicecandidate = event => {
                if (event.candidate) {
                    chatSocket.send(JSON.stringify({
                        'signal': {'candidate': event.candidate},
                        'to': socketID
                    }));
                }
            };

            pc.ontrack = event => {
                const remoteVideo = document.createElement('video');
                remoteVideo.srcObject = event.streams[0];
                remoteVideo.autoplay = true;
                document.getElementById('video-container').appendChild(remoteVideo);
            };

            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
        }

        document.querySelector('#chat-message-submit').onclick = function(e) {
            const message = document.querySelector('#chat-message-input').value;
            chatSocket.send(JSON.stringify({'message': message}));
            document.querySelector('#chat-message-input').value = '';
        };
    </script>
</body>
</html>
